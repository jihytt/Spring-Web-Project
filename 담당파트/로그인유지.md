
> ## 파이널프로젝트 담당 파트 정리 1

<br/>

<img width="50%" src="https://user-images.githubusercontent.com/75427390/148050204-a4cb4da5-4bf6-444f-90d5-176de29dea34.png">


<br/>

로그인 페이지에서 세션과 쿠키를 활용한 **자동로그인, 로그인 유지** 기능 코드를 정리한 글입니다.   
https://rongscodinghistory.tistory.com/3 해당 글을 참고해서 구현했습니다.

<br/>
<br/>

**회원 테이블 구성**

```sql
CREATE TABLE MEMBER(
   MEMBER_NO NUMBER PRIMARY KEY,
   MEMBER_NAME VARCHAR2(20) NOT NULL,
   MEMBER_ID VARCHAR2(20) NOT NULL UNIQUE,
   MEMBER_PW VARCHAR2(20) NOT NULL,
   MEMBER_EMAIL VARCHAR2(50) NOT NULL,
   MEMBER_PHONE VARCHAR2(20) NOT NULL,
   MEMBER_ADDR VARCHAR2(300) NOT NULL,
   MEMBER_PIC VARCHAR2(3000),
   MEMBER_ROLE NUMBER NOT NULL CHECK(MEMBER_ROLE IN(0,1)), -- 관리자 0 , 회원 1
   MEMBER_DELETE NUMBER NOT NULL CHECK(MEMBER_DELETE IN(0,1)), -- 가입중 0 , 탈퇴 1
   MEMBER_SOCIALID VARCAHR2(50),
   -- SessionID 저장
   SESSIONKEY VARCHAR2(50) DEFAULT 'NONE',
   -- 세션 유효시간
   SESSIONLIMIT TIMESTAMP
   );
```

<br/>
<br/>

**memberlogin.jsp**
```jsp
<!-- 로그인 유지 체크박스 -->
<div>
	<input type="checkbox" name="useCookie" id="useCookie"/> 로그인 유지
</div>
```

<br/>

**MemberDto.java**
```java
public class MemberDto {
	
	private int member_no;
	private String member_name;
	private String member_id;
	private String member_pw;
	private String member_email;
	private String member_phone;
	private String member_addr;
	private String member_pic;
	private int member_role ;
	private int member_delete;
	private String member_socialid;
	private String sessionid;
	private Date next;
	private boolean useCookie; // 로그인 유지 사용 여부
	
   // 생성자, setter/getter 작성 생략
}
```

<br/>

**MemberBizImpl.java**
```java
  // 유효기간이 남아있으면서 해당 sessionid를 가지는 사용자 정보 꺼내오기
	@Override
	public MemberDto checkMemberWithSessionKey(String sessionId) {
		return dao.checkMemberWithSessionKey(sessionId);
	}

   // 로그인 유지 체크한 경우 사용자 테이블에 sessionID와 유효시간 저장
	@Override
	public void keepLogin(String member_id, String sessionId, Date next) {
		dao.keepLogin(member_id, sessionId, next);
	}
```

<br/>

**MemberDaoImpl.java**
```java
@Override
public void keepLogin(String member_id, String sessionId, Date next) {
	Map<String, Object> map = new HashMap<String, Object>();
	map.put("member_id", member_id);
	map.put("sessionId", sessionId);
	map.put("next", next);
		
	try {
		sqlSession.update(NAMESPACE+"keepLogin",map);
	} catch (Exception e) {
		e.printStackTrace();
	}
}

@Override
public MemberDto checkMemberWithSessionKey(String sessionId) {
	MemberDto dto = null;
	try {
		dto = sqlSession.selectOne(NAMESPACE+"checkMemberWithSessionKey",sessionId);
	} catch (Exception e) {
		e.printStackTrace();
	}
	return dto;
}
```

<br/>

**member-mapper.xml**
```xml
<select id="checkMemberWithSessionKey" resultType="memberDto">
   SELECT * FROM MEMBER WHERE SESSIONKEY = #{sessionId} AND SESSIONLIMIT > SYSDATE
</select>

<update id="keepLogin">
   UPDATE MEMBER SET SESSIONKEY = #{sessionId}, sessionLimit = #{next} WHERE MEMBER_ID = #{member_id}
</update>
```

<br/>

**MemberController.java**
```java
// 로그인 컨트롤러에서 회원 정보 일치 확인 후
if (dto.isUseCookie()) { // 로그인 유지 체크 시 
   // 쿠키 생성
   // 로그인 시 생성된 세션 ID를 쿠키에 저장
	Cookie cookie = new Cookie("loginCookie", session.getId());
   // 쿠키 경로를 컨텍스트 경로로 변경
	cookie.setPath("/");
   // 쿠키 유효시간 7일로 적용
	int amount = 60*60*24*7;
	cookie.setMaxAge(amount);
   // 쿠키 적용
	response.addCookie(cookie);

   // 세션 유효 시간을 쿠키 유효시간과 동일하게 적용
   // currentTimeMills()는 1/1000초 단위여서 1000을 곱해서 더함
	Date sessionLimit = new Date(System.currentTimeMillis() + (1000*amount));

   // sessionID와 유효 시간 UPDATE
	biz.keepLogin(dto2.getMember_id(), session.getId(), sessionLimit);
}

// 로그아웃
@RequestMapping(value = "/member_logout.do" , method = RequestMethod.GET)
public String logout(HttpServletRequest request, HttpSession session, HttpServletResponse response) throws IOException {

	// 카카오 로그인 시 카카오 계정 로그아웃	    
	if(session.getAttribute("kakao_token") != null) {
		kakaoBiz k_biz = new kakaoBiz();
		k_biz.kakaoLogout();
	}
			
	session = request.getSession();
	// 세션 제거
	session.invalidate();	
			
	// 쿠키가 존재하면
	Cookie loginCookie = WebUtils.getCookie(request, "loginCookie");
	if (loginCookie != null) {
        loginCookie.setPath("/");
            // 쿠키는 없앨 때 유효시간을 0으로 설정
            loginCookie.setMaxAge(0);
			// 쿠키 설정 적용
            response.addCookie(loginCookie);

			// 유효시간을 현재시간으로 재설정        
            Date date =new Date(System.currentTimeMillis());
            biz.keepLogin(dto.getMember_id(), session.getId(), date);
	}

			return "main/main";
		}
```

<br/>





